"use strict";(()=>{var e={};e.id=9217,e.ids=[9217],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},72254:e=>{e.exports=require("node:buffer")},17718:e=>{e.exports=require("node:child_process")},6005:e=>{e.exports=require("node:crypto")},87561:e=>{e.exports=require("node:fs")},93977:e=>{e.exports=require("node:fs/promises")},88849:e=>{e.exports=require("node:http")},22286:e=>{e.exports=require("node:https")},70612:e=>{e.exports=require("node:os")},49411:e=>{e.exports=require("node:path")},97742:e=>{e.exports=require("node:process")},84492:e=>{e.exports=require("node:stream")},41041:e=>{e.exports=require("node:url")},47261:e=>{e.exports=require("node:util")},65628:e=>{e.exports=require("node:zlib")},73826:(e,r,o)=>{o.r(r),o.d(r,{originalPathname:()=>v,patchFetch:()=>x,requestAsyncStorage:()=>c,routeModule:()=>l,serverHooks:()=>m,staticGenerationAsyncStorage:()=>d});var t={};o.r(t),o.d(t,{POST:()=>p});var s=o(73278),i=o(45002),n=o(54877),a=o(71309),u=o(28313);async function p(e){try{console.log("\uD83D\uDCE4 API Upload foto OneDrive - Start");let{foto:r,lavorazioneId:o}=await e.json();if(!r||!o)return a.NextResponse.json({success:!1,error:"Foto e lavorazioneId sono obbligatori"},{status:400});if(!Array.isArray(r))return a.NextResponse.json({success:!1,error:"Foto deve essere un array"},{status:400});console.log(`📷 Uploading ${r.length} foto per lavorazione ${o} su OneDrive`);let t=r.map(async(e,r)=>{try{let t=await (0,u.CS)(e,o,r);return{index:r,success:!0,url:t.url,id:t.id,webUrl:t.webUrl}}catch(e){return console.error(`❌ Errore upload foto ${r}:`,e),{index:r,success:!1,error:e instanceof Error?e.message:"Errore upload"}}}),s=await Promise.all(t),i=s.filter(e=>e.success),n=s.filter(e=>!e.success);return console.log(`✅ Upload OneDrive completato: ${i.length} successi, ${n.length} errori`),a.NextResponse.json({success:!0,data:{foto:i.map(e=>({url:e.url,id:e.id,webUrl:e.webUrl,thumbnailUrl:e.url})),errori:n.length>0?n:void 0}})}catch(e){return console.error("❌ Errore generale upload foto OneDrive:",e),a.NextResponse.json({success:!1,error:"Errore interno del server durante upload foto su OneDrive"},{status:500})}}let l=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/upload-foto-onedrive/route",pathname:"/api/upload-foto-onedrive",filename:"route",bundlePath:"app/api/upload-foto-onedrive/route"},resolvedPagePath:"/Users/akirayouky/Desktop/Siti/Condomini/src/app/api/upload-foto-onedrive/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:c,staticGenerationAsyncStorage:d,serverHooks:m}=l,v="/api/upload-foto-onedrive/route";function x(){return(0,n.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:d})}},28313:(e,r,o)=>{o.d(r,{CS:()=>p,wm:()=>l}),o(80246);var t=o(80995),s=o(99008);let i=process.env.MICROSOFT_TENANT_ID||"",n=process.env.MICROSOFT_CLIENT_ID||"",a=process.env.MICROSOFT_CLIENT_SECRET||"";function u(){let e=new s.Rp(i,n,a);return t.KU.initWithMiddleware({authProvider:{getAccessToken:async()=>(await e.getToken("https://graph.microsoft.com/.default")).token}})}async function p(e,r,o){try{let t=u(),s=Date.now(),i=`foto-${o}-${s}.jpg`,n=`/me/drive/root:/Apps/CondominieApp/lavorazioni/${r}`,a=`${n}/${i}:`;console.log("\uD83D\uDCE4 Uploading foto to OneDrive:",{lavorazioneId:r,fotoIndex:o,fileName:i});let p=e.replace(/^data:image\/\w+;base64,/,""),l=Buffer.from(p,"base64");try{await t.api(`${n}`).get()}catch(e){console.log("\uD83D\uDCC1 Creando cartella lavorazione su OneDrive..."),await t.api("/me/drive/root:/Apps/CondominieApp/lavorazioni:/children").post({name:r,folder:{},"@microsoft.graph.conflictBehavior":"rename"})}let c=await t.api(a).putStream(l);console.log("✅ Foto uploaded to OneDrive:",c.id);let d=await t.api(`/me/drive/items/${c.id}/createLink`).post({type:"view",scope:"anonymous"});return{id:c.id,url:d.link.webUrl,webUrl:c.webUrl}}catch(e){throw console.error("❌ Errore upload OneDrive:",e),Error("Errore durante upload su OneDrive")}}async function l(){try{let e=u(),r=await e.api("/me").get();return console.log("✅ OneDrive connesso per utente:",r.displayName),{success:!0,user:{displayName:r.displayName,email:r.mail||r.userPrincipalName,id:r.id}}}catch(e){return console.error("❌ OneDrive non configurato correttamente:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}}};var r=require("../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),t=r.X(0,[9379,4833,4640,982],()=>o(73826));module.exports=t})();